// Translations
        share_msg: "Check out this upcycling idea: ",
        share_success: "Link copied to clipboard!",
        nav_comm: "Community",
        comm_title: "Community Gallery ‚ú®",
        comm_desc: "Share your \"Before & After\" transformations with the world!",
        comm_btn_share: "Share Your Project",
        modal_title: "Share Your Project",
        label_name: "Name",
        label_before: "Before Photo",
        label_after: "After Photo",
        label_desc: "Description",
        modal_btn_submit: "Post to Gallery"
    },
    ko: {
        nav_home: "Ìôà",
        nav_how: "ÏÇ¨Ïö© Î∞©Î≤ï",
        nav_insp: "ÏòÅÍ∞ê ÏñªÍ∏∞",
        nav_saved: "‚ù§Ô∏è ÎÇ¥ Î≥¥Í¥ÄÌï®",
        hero_title: "Î≤ÑÎ¶¨ÏßÄ ÎßêÍ≥†, Î≥ÄÏã†ÏãúÌÇ§ÏÑ∏Ïöî",
        hero_desc: "AIÏùò ÌûòÏúºÎ°ú ÏùºÏÉÅ ÏÜç Î¨ºÍ±¥Îì§ÏùÑ Ï∞ΩÏùòÏ†ÅÏù¥Í≥† ÏßÄÏÜç Í∞ÄÎä•Ìïú Î∞©ÏãùÏúºÎ°ú Ïû¨ÏÇ¨Ïö©ÌïòÎäî Î∞©Î≤ïÏùÑ Î∞úÍ≤¨ÌïòÏÑ∏Ïöî.",
        upload_title: "Î¨ºÍ±¥ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú",
        upload_desc: "Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî",
        upload_btn: "ÌååÏùº ÏÑ†ÌÉù",
        analyze_btn: "‚ú® ÏïÑÏù¥ÎîîÏñ¥ ÏÉùÏÑ±ÌïòÍ∏∞",
        results_title: "ÏóÖÏÇ¨Ïù¥ÌÅ¥ÎßÅ ÏïÑÏù¥ÎîîÏñ¥:",
        saved_title: "ÎÇòÏùò Î≥¥Í¥ÄÌï® ‚ù§Ô∏è",
        saved_empty: "ÏïÑÏßÅ Ï†ÄÏû•Îêú ÏïÑÏù¥ÎîîÏñ¥Í∞Ä ÏóÜÏäµÎãàÎã§. Î¨ºÍ±¥ÏùÑ Î∂ÑÏÑùÌïòÍ≥† ÏïÑÏù¥ÎîîÏñ¥Î•º Î™®ÏïÑÎ≥¥ÏÑ∏Ïöî!",
        saved_btn_find: "ÏïÑÏù¥ÎîîÏñ¥ Ï∞æÍ∏∞",
        how_title: "ÏÇ¨Ïö© Î∞©Î≤ï",
        how_desc: "Upcycle AIÎäî Í≥†Í∏â Ïù¥ÎØ∏ÏßÄ Ïù∏ÏãùÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Î≤ÑÎ†§ÏßÑ Î¨ºÍ±¥ÏùÑ ÏãùÎ≥ÑÌïòÍ≥† Ï∞ΩÏùòÏ†ÅÏù∏ DIY ÌîÑÎ°úÏ†ùÌä∏Î•º Ï†úÏïàÌï©ÎãàÎã§. Ïö∞Î¶¨Ïùò Î™©ÌëúÎäî ÏùºÏÉÅ Î¨ºÍ±¥Ïùò ÏàòÎ™ÖÏùÑ Ïó∞Ïû•ÌïòÏó¨ ÏßÄÏÜç Í∞ÄÎä•ÏÑ±ÏùÑ Ï¥âÏßÑÌïòÎäî Í≤ÉÏûÖÎãàÎã§.",
        step1_title: "1. ÏãùÎ≥Ñ",
        step1_desc: "Î≤ÑÎ¶¨Î†§Îäî Î¨ºÍ±¥(Î≥ë, ÏÉÅÏûê, Ìóå Ïò∑, Í∞ÄÍµ¨ Îì±)Ïùò ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.",
        step2_title: "2. Î∏åÎ†àÏù∏Ïä§ÌÜ†Î∞ç",
        step2_desc: "AIÍ∞Ä Ïû¨ÏßàÍ≥º Î™®ÏñëÏùÑ Î∂ÑÏÑùÌïòÏó¨ ÎèÖÌäπÌïòÍ≥† Ïã§Ïö©Ï†ÅÏù¥Î©∞ Ïã¨ÎØ∏Ï†ÅÏù∏ ÏóÖÏÇ¨Ïù¥ÌÅ¥ÎßÅ ÏïÑÏù¥ÎîîÏñ¥Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.",
        step3_title: "3. Ï†úÏûë",
        step3_desc: "ÎèÑÍµ¨ Î™©Î°ùÍ≥º ÎÇúÏù¥ÎèÑÍ∞Ä Ìè¨Ìï®Îêú Í∞ÑÎã®Ìïú Í∞ÄÏù¥ÎìúÎ•º Îî∞Îùº ÏÉàÎ°úÏö¥ Î¨ºÍ±¥ÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî.",
        gallery_title: "ÏòÅÍ∞ê Í∞§Îü¨Î¶¨",
        gallery_desc: "Í∞ÄÎä•ÏÑ±ÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî. Ïª§ÎÆ§ÎãàÌã∞ÏóêÏÑú ÏÉùÏÑ±Îêú Ïù∏Í∏∞ ÌîÑÎ°úÏ†ùÌä∏Îì§ÏûÖÎãàÎã§.",
        gal1_title: "ÏôÄÏù∏Î≥ë Îû®ÌîÑ",
        gal1_desc: "Îπà Ïú†Î¶¨Î≥ëÏóê ÌéòÏñ¥Î¶¨ ÎùºÏù¥Ìä∏ÎÇò Îû®ÌîÑ ÌÇ§Ìä∏Î•º ÎÑ£Ïñ¥ Ïö∞ÏïÑÌïú ÌÖåÏù¥Î∏î Îû®ÌîÑÎ°ú Î≥ÄÏã†ÏãúÌÇ§ÏÑ∏Ïöî.",
        gal2_title: "Ï≤≠Î∞îÏßÄ ÌÜ†Ìä∏Î∞±",
        gal2_desc: "Ìóå Ï≤≠Î∞îÏßÄÎ•º ÌäºÌäºÌïòÍ≥† Ïä§ÌÉÄÏùºÎ¶¨ÏãúÌïú Ïû•Î∞îÍµ¨ÎãàÏö© ÌÜ†Ìä∏Î∞±ÏúºÎ°ú Î¶¨ÌèºÌï¥Î≥¥ÏÑ∏Ïöî.",
        gal3_title: "ÌÜµÏ°∞Î¶º Ï∫î ÌôîÎ∂Ñ",
        gal3_desc: "ÌÜµÏ°∞Î¶º Ï∫îÏùÑ ÏîªÏñ¥ Î∞ùÏùÄ ÏÉâÏúºÎ°ú Ïπ†ÌïòÍ≥† Ï£ºÎ∞©Ïö© ÌóàÎ∏åÎ•º ÌÇ§Ïö∞Îäî ÌôîÎ∂ÑÏúºÎ°ú ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.",
        gal4_title: "ÏÇ¨Îã§Î¶¨ Ï±ÖÏû•",
        gal4_desc: "Ïò§ÎûòÎêú ÎÇòÎ¨¥ ÏÇ¨Îã§Î¶¨Î•º Î≤ΩÏóê ÏàòÌèâÏúºÎ°ú ÏÑ§ÏπòÌïòÏó¨ ÏÜåÎ∞ïÌïòÍ≥† Í≥µÍ∞Ñ Ï†àÏïΩÌòïÏù∏ Ï±ÖÏû•ÏùÑ ÎßåÎìúÏÑ∏Ïöî.",
        loading_text: "Ïû†Ïû¨Î†•ÏùÑ Î∂ÑÏÑùÌïòÎäî Ï§ë...",
        footer_text: "&copy; 2026 Upcycle AI. ÏßÄÏÜç Í∞ÄÎä•Ìïú ÏÉùÌôúÏùÑ ÏúÑÌïú ÏûëÏùÄ Ïã§Ï≤ú.",
        tools_label: "Ï§ÄÎπÑÎ¨º:",
        save_btn: "Ï†ÄÏû•",
        saved_btn: "Ï†ÄÏû•Îê®",
        share_btn: "Í≥µÏú†",
        share_msg: "Ïù¥ ÏóÖÏÇ¨Ïù¥ÌÅ¥ÎßÅ ÏïÑÏù¥ÎîîÏñ¥ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî: ",
        share_success: "ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!",
        nav_comm: "Ïª§ÎÆ§ÎãàÌã∞",
        comm_title: "Ïª§ÎÆ§ÎãàÌã∞ Í∞§Îü¨Î¶¨ ‚ú®",
        comm_desc: "Ïó¨Îü¨Î∂ÑÏùò ÎÜÄÎùºÏö¥ \"Before & After\" Î≥ÄÏã†ÏùÑ ÏÑ∏ÏÉÅÏóê Í≥µÏú†ÌïòÏÑ∏Ïöî!",
        comm_btn_share: "ÏûëÌíà Í≥µÏú†ÌïòÍ∏∞",
        modal_title: "ÏûëÌíà Í≥µÏú†ÌïòÍ∏∞",
        label_name: "Ïù¥Î¶Ñ",
        label_before: "Î≥ÄÏã† Ï†Ñ (Before)",
        label_after: "Î≥ÄÏã† ÌõÑ (After)",
        label_desc: "ÏÑ§Î™Ö",
        modal_btn_submit: "Í∞§Îü¨Î¶¨Ïóê Ïò¨Î¶¨Í∏∞"
    }
};

// Mock Community Data
const MOCK_COMMUNITY = [
    {
        id: 1,
        user: "GreenLife",
        before: "https://images.unsplash.com/photo-1591017403986-ed818453c11d?auto=format&fit=crop&q=80&w=200",
        after: "https://images.unsplash.com/photo-1581781870027-04212e231e96?auto=format&fit=crop&q=80&w=200",
        desc: "Old wine bottles turned into aesthetic plant propagators. Simple and beautiful!",
        likes: 24,
        liked: false
    },
    {
        id: 2,
        user: "DIY_King",
        before: "https://images.unsplash.com/photo-1544816155-12df9643f363?auto=format&fit=crop&q=80&w=200",
        after: "https://images.unsplash.com/photo-1584622650111-993a426fbf0a?auto=format&fit=crop&q=80&w=200",
        desc: "Repurposed a wooden pallet into a vertical garden for my small balcony.",
        likes: 56,
        liked: true
    }
];

// Mock Data
const MOCK_DATA = {
    en: {
        "detected_item": "Empty Glass Wine Bottle",
        "ideas": [
            {
                "id": 1,
                "type": "Easy Start",
                "title": "Minimalist Single-Stem Vase",
                "description": "Transform that bottle into a chic vase by removing the label and wrapping the neck with twine for a rustic touch.",
                "difficulty": "Easy",
                "required_tools": ["Warm Water", "Scrubbing Sponge", "Jute Twine", "Scissors", "Clear Glue"]
            },
            {
                "id": 2,
                "type": "Aesthetic Decor",
                "title": "Fairy Light Lantern",
                "description": "Create a magical ambiance by stuffing the bottle with battery-operated copper wire fairy lights. perfect for nightstands.",
                "difficulty": "Medium",
                "required_tools": ["Fairy Lights (Battery Op)", "Glass Paint (Optional)", "Cork Stopper"]
            },
            {
                "id": 3,
                "type": "Functional Use",
                "title": "Self-Watering Planter",
                "description": "Cut the bottle in half to create a self-watering system for your herbs. The top holds the soil, inverted into the water-filled base.",
                "difficulty": "Hard",
                "required_tools": ["Glass Cutter", "Sandpaper", "Potting Soil", "Cotton String", "Herb Seedling"]
            }
        ]
    },
    ko: {
        "detected_item": "Îπà ÏôÄÏù∏ Ïú†Î¶¨Î≥ë",
        "ideas": [
            {
                "id": 1,
                "type": "Ïâ¨Ïö¥ ÏãúÏûë",
                "title": "ÎØ∏ÎãàÎ©Ä ÌïúÏÜ°Ïù¥ ÌôîÎ≥ë",
                "description": "ÎùºÎ≤®ÏùÑ Ï†úÍ±∞ÌïòÍ≥† Î≥ëÎ™©ÏùÑ ÎßàÎÅàÏúºÎ°ú Í∞êÏã∏ ÏÜåÎ∞ïÌïú ÎäêÎÇåÏùÑ Ï£ºÎäî ÏãúÌÅ¨Ìïú ÌôîÎ≥ëÏúºÎ°ú Î≥ÄÏã†ÏãúÌÇ§ÏÑ∏Ïöî.",
                "difficulty": "Ïâ¨ÏõÄ",
                "required_tools": ["Îî∞ÎúªÌïú Î¨º", "ÏàòÏÑ∏ÎØ∏", "ÎßàÎÅà", "Í∞ÄÏúÑ", "Ìà¨Î™Ö ÌíÄ"]
            },
            {
                "id": 2,
                "type": "Í∞êÏÑ± Îç∞ÏΩî",
                "title": "Î¨¥ÎìúÎì± ÎûúÌÑ¥",
                "description": "Î∞∞ÌÑ∞Î¶¨Î°ú ÏûëÎèôÌïòÎäî ÏΩîÌçº ÏôÄÏù¥Ïñ¥ Ï°∞Î™ÖÏùÑ Î≥ë ÏïàÏóê ÎÑ£Ïñ¥ ÎßàÎ≤ï Í∞ôÏùÄ Î∂ÑÏúÑÍ∏∞Î•º Ïó∞Ï∂úÌïòÏÑ∏Ïöî. Ïπ®ÎåÄ ÌòëÌÉÅÏóê ÏôÑÎ≤ΩÌï©ÎãàÎã§.",
                "difficulty": "Î≥¥ÌÜµ",
                "required_tools": ["ÌéòÏñ¥Î¶¨ ÎùºÏù¥Ìä∏ (Í±¥Ï†ÑÏßÄÏãù)", "Ïú†Î¶¨ Î¨ºÍ∞ê (ÏÑ†ÌÉù)", "ÏΩîÎ•¥ÌÅ¨ ÎßàÍ∞ú"]
            },
            {
                "id": 3,
                "type": "Ïã§Ïö©Ï†Å ÌôúÏö©",
                "title": "ÏûêÎèô Í∏âÏàò ÌôîÎ∂Ñ",
                "description": "Î≥ëÏùÑ Î∞òÏúºÎ°ú ÏûòÎùº ÌóàÎ∏åÎ•º ÏúÑÌïú ÏûêÎèô Í∏âÏàò ÏãúÏä§ÌÖúÏùÑ ÎßåÎìúÏÑ∏Ïöî. ÏúóÎ∂ÄÎ∂ÑÏóêÎäî ÌùôÏùÑ Îã¥Í≥†, Î¨ºÏù¥ Îã¥Í∏¥ ÏïÑÎû´Î∂ÄÎ∂ÑÏóê Í±∞Íæ∏Î°ú ÍΩÇÏäµÎãàÎã§.",
                "difficulty": "Ïñ¥Î†§ÏõÄ",
                "required_tools": ["Ïú†Î¶¨ Ï†àÎã®Í∏∞", "ÏÇ¨Ìè¨", "Î∂ÑÍ∞àÏù¥ Ìùô", "Î©¥ ÎÅà", "ÌóàÎ∏å Î™®Ï¢Ö"]
            }
        ]
    }
};

let currentLang = 'en'; // Default

document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const imagePreview = document.getElementById('image-preview');
    const previewContainer = document.getElementById('preview-container');
    const removeImageBtn = document.getElementById('remove-image');
    const analyzeBtn = document.getElementById('analyze-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const resultsSection = document.getElementById('results-section');
    const ideasContainer = document.getElementById('ideas-container');
    const detectedItemName = document.getElementById('detected-item-name');
    
    // Saved Ideas Elements
    const savedSection = document.getElementById('saved-section');
    const savedContainer = document.getElementById('saved-container');
    const emptySavedState = document.getElementById('empty-saved-state');
    const navSaved = document.getElementById('nav-saved');
    const navHome = document.getElementById('nav-home');
    const navCommunity = document.getElementById('nav-community');
    const btnStartSaving = document.getElementById('btn-start-saving');
    
    // Community Elements
    const communitySection = document.getElementById('community-section');
    const communityContainer = document.getElementById('community-container');
    const btnOpenShareModal = document.getElementById('btn-open-share-modal');
    const shareModal = document.getElementById('share-modal');
    const btnCloseModal = document.getElementById('btn-close-modal');
    const shareForm = document.getElementById('share-form');

    // Language Elements
    const btnLang = document.getElementById('btn-lang');

    // --- Language Logic ---
    function setLanguage(lang) {
        if (!TRANSLATIONS[lang]) lang = 'en'; // Safety fallback
        currentLang = lang;
        localStorage.setItem('preferredLang', lang);
        
        // Update Document Attributes for CSS Switching
        document.documentElement.setAttribute('data-lang', lang);
        document.documentElement.lang = lang;
        
        // Update Button Text
        btnLang.textContent = lang === 'en' ? 'üá∞üá∑ KO' : 'üá∫üá∏ EN';

        // Update Text Content
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) {
                if (key === 'footer_text') {
                     el.innerHTML = TRANSLATIONS[lang][key];
                } else {
                    el.textContent = TRANSLATIONS[lang][key];
                }
            }
        });

        // Re-render dynamic content if visible
        if (!resultsSection.classList.contains('hidden')) {
             renderResults(MOCK_DATA[lang]);
        }
        
        if (!savedSection.classList.contains('hidden')) {
            renderSavedIdeas();
        }

        if (!communitySection.classList.contains('hidden')) {
            renderCommunity();
        }
    }

    // Initialize Language
    const savedLang = localStorage.getItem('preferredLang');
    if (savedLang) {
        setLanguage(savedLang);
    } else {
        const browserLang = navigator.language.startsWith('ko') ? 'ko' : 'en';
        setLanguage(browserLang);
    }

    // Toggle Language
    btnLang.addEventListener('click', () => {
        const newLang = currentLang === 'en' ? 'ko' : 'en';
        setLanguage(newLang);
    });


    // --- Section Visibility Logic ---
    const sections = {
        home: [document.getElementById('hero-section'), document.getElementById('upload-section')],
        saved: [savedSection],
        community: [communitySection]
    };

    function showSection(sectionName) {
        // Hide all major sections
        Object.values(sections).flat().forEach(el => el.classList.add('hidden'));
        resultsSection.classList.add('hidden'); // Results are part of home flow but handled dynamically
        
        // Show target section
        if (sections[sectionName]) {
            sections[sectionName].forEach(el => el.classList.remove('hidden'));
        }

        if (sectionName === 'saved') {
            renderSavedIdeas();
        }

        if (sectionName === 'community') {
            renderCommunity();
        }
    }

    // Navigation Events
    navSaved.addEventListener('click', (e) => {
        e.preventDefault();
        showSection('saved');
    });

    navHome.addEventListener('click', (e) => {
        e.preventDefault();
        showSection('home');
        if (detectedItemName.textContent !== '...') {
             resultsSection.classList.remove('hidden');
        }
    });

    navCommunity.addEventListener('click', (e) => {
        e.preventDefault();
        showSection('community');
    });

    btnStartSaving.addEventListener('click', () => {
        showSection('home');
    });

    // --- Community Logic ---
    function renderCommunity() {
        communityContainer.innerHTML = '';
        const t = TRANSLATIONS[currentLang]; // Get current translations

        MOCK_COMMUNITY.forEach(post => {
            const card = document.createElement('div');
            card.className = 'comm-card';
            
            // Use translated labels for Before/After
            // We can infer these from the keys or add new keys. 
            // Existing keys: label_before, label_after (used in modal). 
            // Let's use generic terms or reuse those.
            // label_before is "Before Photo" / "Î≥ÄÏã† Ï†Ñ (Before)". A bit long for a badge.
            // Let's make short labels map.
            const labels = {
                en: { before: "Before", after: "After", time: "Just now" },
                ko: { before: "Ï†Ñ", after: "ÌõÑ", time: "Î∞©Í∏à Ï†Ñ" }
            };
            const lbl = labels[currentLang];

            card.innerHTML = `
                <div class="comm-images">
                    <div class="comm-img-box">
                        <img src="${post.before}" alt="Before">
                        <span class="img-label">${lbl.before}</span>
                    </div>
                    <div class="comm-img-box">
                        <img src="${post.after}" alt="After">
                        <span class="img-label">${lbl.after}</span>
                    </div>
                </div>
                <div class="comm-body">
                    <p class="comm-user">@${post.user}</p>
                    <p class="comm-desc">${post.desc}</p>
                </div>
                <div class="comm-footer">
                    <button class="btn-like ${post.liked ? 'active' : ''}" data-id="${post.id}">
                        ${post.liked ? '‚ù§Ô∏è' : 'ü§ç'} <span>${post.likes}</span>
                    </button>
                    <small style="color: #94a3b8;">${lbl.time}</small>
                </div>
            `;

            const likeBtn = card.querySelector('.btn-like');
            likeBtn.addEventListener('click', () => {
                post.liked = !post.liked;
                post.likes += post.liked ? 1 : -1;
                renderCommunity();
            });

            communityContainer.appendChild(card);
        });
    }

    // Modal Logic
    btnOpenShareModal.addEventListener('click', () => {
        shareModal.classList.remove('hidden');
    });

    btnCloseModal.addEventListener('click', () => {
        shareModal.classList.add('hidden');
    });

    window.addEventListener('click', (e) => {
        if (e.target === shareModal) {
            shareModal.classList.add('hidden');
        }
    });

    shareForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const newUser = document.getElementById('post-user').value;
        const newDesc = document.getElementById('post-desc').value;
        
        // In a real app, we'd handle file uploads here. 
        // For mock, we'll use placeholders.
        const newPost = {
            id: MOCK_COMMUNITY.length + 1,
            user: newUser,
            before: "https://images.unsplash.com/photo-1536939459926-301728717817?auto=format&fit=crop&q=80&w=200",
            after: "https://images.unsplash.com/photo-1513519245088-0e12902e5a38?auto=format&fit=crop&q=80&w=200",
            desc: newDesc,
            likes: 0,
            liked: false
        };

        MOCK_COMMUNITY.unshift(newPost);
        renderCommunity();
        shareModal.classList.add('hidden');
        shareForm.reset();
    });


    // --- Drag and Drop Events ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        dropZone.classList.add('drag-over');
    }

    function unhighlight() {
        dropZone.classList.remove('drag-over');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    // Click to Upload
    uploadBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent bubbling to dropZone click if nested
        fileInput.click();
    });
    
    // Also make the whole box clickable if empty
    dropZone.addEventListener('click', () => {
        if(previewContainer.classList.contains('hidden')) {
            fileInput.click();
        }
    });

    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function handleFiles(files) {
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                previewFile(file);
            } else {
                alert('Please upload an image file.');
            }
        }
    }

    function previewFile(file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onloadend = function() {
            imagePreview.src = reader.result;
            previewContainer.classList.remove('hidden');
            analyzeBtn.classList.remove('hidden');
            analyzeBtn.disabled = false;
        }
    }

    // Remove Image
    removeImageBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent triggering dropZone click
        imagePreview.src = '';
        previewContainer.classList.add('hidden');
        analyzeBtn.classList.add('hidden');
        analyzeBtn.disabled = true;
        fileInput.value = ''; // Reset input
        resultsSection.classList.add('hidden');
    });

    // Generate Ideas (Mock AI Call)
    analyzeBtn.addEventListener('click', async () => {
        showLoading(true);
        
        // Simulate network delay
        setTimeout(() => {
            renderResults(MOCK_DATA[currentLang]);
            showLoading(false);
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 2000);
    });

    function showLoading(show) {
        if (show) {
            loadingOverlay.classList.remove('hidden');
        } else {
            loadingOverlay.classList.add('hidden');
        }
    }

    // --- Saved Ideas Logic ---
    function getSavedIdeas() {
        const saved = localStorage.getItem('savedIdeas');
        return saved ? JSON.parse(saved) : [];
    }

    function toggleSave(idea) {
        const savedIdeas = getSavedIdeas();
        const index = savedIdeas.findIndex(item => item.id === idea.id && item.title === idea.title);
        
        if (index > -1) {
            savedIdeas.splice(index, 1);
        } else {
            savedIdeas.push(idea);
        }
        
        localStorage.setItem('savedIdeas', JSON.stringify(savedIdeas));
        return index === -1; 
    }

    function isSaved(idea) {
        const savedIdeas = getSavedIdeas();
        return savedIdeas.some(item => item.id === idea.id && item.title === idea.title);
    }

    // --- Sharing Logic ---
    async function handleShare(idea) {
        const shareData = {
            title: `Upcycle AI: ${idea.title}`,
            text: `${TRANSLATIONS[currentLang].share_msg} ${idea.title} - ${idea.description}`,
            url: window.location.href
        };

        if (navigator.share) {
            try {
                await navigator.share(shareData);
            } catch (err) {
                console.log('Error sharing:', err);
            }
        } else {
            // Fallback: Copy to clipboard
            try {
                await navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`);
                alert(TRANSLATIONS[currentLang].share_success);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
    }

    function createCardHTML(idea, saved) {
        let cssClass = 'medium';
        const diffLower = idea.difficulty.toLowerCase();
        if (diffLower.includes('easy') || diffLower.includes('Ïâ¨ÏõÄ')) cssClass = 'easy';
        if (diffLower.includes('hard') || diffLower.includes('Ïñ¥Î†§ÏõÄ')) cssClass = 'hard';

        const heartIcon = saved ? '‚ù§Ô∏è' : 'ü§ç';
        const btnClass = saved ? 'btn-save saved' : 'btn-save';
        
        const saveText = saved ? TRANSLATIONS[currentLang].saved_btn : TRANSLATIONS[currentLang].save_btn;
        const shareText = TRANSLATIONS[currentLang].share_btn;
        const toolsLabel = TRANSLATIONS[currentLang].tools_label;

        return `
            <div class="card-header">
                <span class="card-type">${idea.type}</span>
                <h3 class="card-title">${idea.title}</h3>
                <span class="badge ${cssClass}">${idea.difficulty}</span>
            </div>
            <div class="card-body">
                <p class="card-description">${idea.description}</p>
                <div class="tools-section">
                    <h4>${toolsLabel}</h4>
                    <div class="tools-list">
                        ${idea.required_tools.map(tool => `<span class="tool-tag">${tool}</span>`).join('')}
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn-share" data-id="${idea.id}" aria-label="Share">
                    üîó <span>${shareText}</span>
                </button>
                <button class="${btnClass}" data-id="${idea.id}" aria-label="Save to favorites">
                    ${heartIcon} <span>${saveText}</span>
                </button>
            </div>
        `;
    }

    function renderResults(data) {
        detectedItemName.textContent = data.detected_item;
        ideasContainer.innerHTML = ''; 

        data.ideas.forEach(idea => {
            const card = document.createElement('article');
            card.className = 'idea-card';
            
            const saved = isSaved(idea);
            card.innerHTML = createCardHTML(idea, saved);
            
            // Save Button Event
            const saveBtn = card.querySelector('.btn-save');
            saveBtn.addEventListener('click', () => {
                const isNowSaved = toggleSave(idea);
                const newSaveText = isNowSaved ? TRANSLATIONS[currentLang].saved_btn : TRANSLATIONS[currentLang].save_btn;
                saveBtn.innerHTML = `${isNowSaved ? '‚ù§Ô∏è' : 'ü§ç'} <span>${newSaveText}</span>`;
                saveBtn.className = isNowSaved ? 'btn-save saved' : 'btn-save';
            });

            // Share Button Event
            const shareBtn = card.querySelector('.btn-share');
            shareBtn.addEventListener('click', () => {
                handleShare(idea);
            });
            
            ideasContainer.appendChild(card);
        });

        resultsSection.classList.remove('hidden');
    }

    function renderSavedIdeas() {
        const savedIdeas = getSavedIdeas();
        savedContainer.innerHTML = '';

        if (savedIdeas.length === 0) {
            emptySavedState.classList.remove('hidden');
            savedContainer.classList.add('hidden');
            return;
        }

        emptySavedState.classList.add('hidden');
        savedContainer.classList.remove('hidden');

        savedIdeas.forEach(idea => {
            const card = document.createElement('article');
            card.className = 'idea-card';
            card.innerHTML = createCardHTML(idea, true);
            
            const saveBtn = card.querySelector('.btn-save');
            saveBtn.addEventListener('click', () => {
                toggleSave(idea);
                renderSavedIdeas();
            });

            // Share Button Event for Saved Ideas
            const shareBtn = card.querySelector('.btn-share');
            shareBtn.addEventListener('click', () => {
                handleShare(idea);
            });

            savedContainer.appendChild(card);
        });
    }
});